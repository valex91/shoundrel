#!/usr/bin/env bash

DEBUG='true'

currentDir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

source $currentDir/lib/tui
source $currentDir/lib/utils
source $currentDir/lib/cards
source $currentDir/lib/array

ROWS=0
COLS=0

#setup system
gotoTab
clearScreen
moveCursor

getSize ROWS COLS

getTermSize() {
 deblog 'getTermSize called'
 getSize ROWS COLS
}

cleanUp() {
	returnTab
	showCursor
}

# TRAPS
trap 'getTermSize' WINCH
trap cleanUp exit 


hideCursor

echo "$ROWS $COLS"


# STATE
HP=20
ROOM=()
DECK=()
ELEMENT_X=0
POTION_USED_THIS_TURN=false
SKIPPED_PREV_ROOM=false
EQUIPPED_WEAPON=0
_ROOM_SIZE_=4
DRAWN_CARD_SIZE=7
# ICONS
SWORD=$'\u2694'

# INIT
createDeck DECK

generateRoom() {
 local currentRoomSize=${#ROOM[@]}
 local turnSkip=${1:-false}

 if [[ $turnSkip == true ]]; then
	 local amountToDraw=$(min 4 ${#DECK[@]} )
	 splice DECK 0 $amountToDraw ROOM
 else
	 local diff=$((_ROOM_SIZE_ - currentRoomSize))
   local justDrawn=()
	 local amountToDraw=$(min ${#DECK[@]} $diff)
	 splice DECK 0 $diff justDrawn
	 ROOM=("${justDrawn[@]}" "${ROOM[@]}")
 fi
}

generateRoom

drawLoop() {
	clearScreen
	moveCursor
	local currentIndex=0
	local isSelected=false

	local terminalCenterX=$(($ROWS / 2))
	local terminalCenterY=$(( ($COLS / 2) - $DRAWN_CARD_SIZE ))
	
	# ROOM
	for card in "${ROOM[@]}"; do
		isSelected=$(( currentIndex == ELEMENT_X ))
		# term is not 0 indexed pt 2
		local columnToDraw=$(( ($currentIndex * $DRAWN_CARD_SIZE + 1) + $terminalCenterY ))
		interpolateCard "$card" "$isSelected" "$columnToDraw" "$terminalCenterX"
		printf '  '
		(( currentIndex++ ))
	done

	# health
	printf '[ %s\u2695 ]' $HP

	# Weapon
	if (( EQUIPPED_WEAPON > 0 )); then 
		printf '[%s  %b]' $EQUIPPED_WEAPON $WEAPON
	else
			printf '[%s  %b]' $EQUIPPED_WEAPON $FIST
 	fi
}

nextTurn() {
	SKIPPED_PREV_ROOM=false
	generateRoom
}

strategy() {
	local seed=$1
	local value=$2

	case $seed in
		1|2) 
			local monsterInteractionResult=$((value - EQUIPPED_WEAPON))
			local weaponConsumption=$((EQUIPPED_WEAPON - value))
			local safeMonsterInteractionResult=$(clampFloor $monsterInteractionResult 0)
			local safeWeaponConsumption=$(clampFloor $weaponConsumption 0)
			EQUIPPED_WEAPON=$safeWeaponConsumption
			(( HP -= $safeMonsterInteractionResult ));;
		3) local hpWithPotion=$(( HP + value ))
			HP=$(max $hpWithPotion 20);;
		4) EQUIPPED_WEAPON=$value;;
	esac

	currentRoomSize=${#ROOM[@]}
	currentDeckSize=${#DECK[@]}
	if (( $HP <= 0 )); then
		echo "lost"
		exit 0
	fi

	if (( $currentDeckSize == 0 )); then
		echo "win"
		exit 0
	fi


	if (( $currentRoomSize <= 1 )); then 
		nextTurn
	fi
}

gameLoopTick() {
	local pick=${ROOM[ELEMENT_X]}
	local value
	local seed

	# pick the selected card from the room and consume it
	local pickedIdx=$(findIndex ROOM $pick)
	splice ROOM $pickedIdx 1

	# parsing the picked card
	IFS='_' read -r value seed <<< "$pick"

  strategy "$seed" "$value"
}

skipRoom() {
 if [[ $SKIPPED_PREV_ROOM == false ]]; then
	 generateRoom true
	 SKIPPED_PREV_ROOM=true
 fi
}

handleKeys() {
 local input=$1

 case $input in
	 a) (( ELEMENT_X = (ELEMENT_X - 1 + ${#ROOM[@]} ) % ${#ROOM[@]}  ));;
	 d) (( ELEMENT_X = (ELEMENT_X + 1) % ${#ROOM[@]}  ));;
	 e) gameLoopTick $input;;
	 n) skipRoom;;
	esac
}

main() {
 local inputK=$1
 handleKeys "$inputK"
 drawLoop
}


drawLoop

# Main loop reading keys
while true; do
	read -rsn1 key
	main $key
done



